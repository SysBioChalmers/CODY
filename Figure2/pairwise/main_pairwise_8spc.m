function main_pairwise
clc
clear
close all

currentDepth = 1; 
currPath = fileparts(mfilename('fullpath'));% get current path
cd(currPath);
blank_inx=0;
addpath('./software');
addpath('./data');
load 8SPC_0405
spc_lth=size(SPC,2);
for i=1:spc_lth
    subs_cn{i}=SPC{i}.subs_cn;
    Expdata{i}=SPC{i}.expdata;
    met{i}=SPC{i}.met_udf;
    Substrate{i}=Expdata{i}(1,subs_cn{i}+1);  %%????????????????????????????????????????????

      if i<=5  
        Sug_org=SPC{i}.expdata(1,3);
        SPC{i}.expdata(1,3)=80;

      elseif i==6   %% E.hallii
            SPC{i}.expdata(1,3)=60;   %% ????????????????????????acetate

      else
            SPC{i}.expdata(1,3)=80;   %% ????????????????????acetate
            SPC{i}.expdata(1,4)=60;   %% 
      end
      SPC{i}.expdata(1,2)=0.01/SPC{i}.biom_coef;   %% ????????????8????????????????????????????????????????????

    end
% end

Result_pure=[];
Biomass_pure=[];
Pure_miu=[];
Pure_id=[];
for i=1:spc_lth   
    [Tmodel,Ymodel,Texp,Yexp,miu]=common_pure_simulation_for_pairwise(SPC{i},i);
    Result_pure=[Result_pure Ymodel];  
    Biomass_pure=[Biomass_pure Ymodel(:,1)];
    Pure_id=[Pure_id {SPC{i}.id}];
    Pure_miu=[Pure_miu miu];
end
save Result_pure Result_pure
Tspan=0:0.02:24;
Biomass_pure=[Tspan' Biomass_pure];
% xlswrite(Result_file_pairwise{1},Simulation_Pure,'Pure_culture'); 
save Biomass_pure Biomass_pure
save Pure_miu Pure_miu
save Pure_id Pure_id

clear all  
clc
%% ????????????
load Result_pure
load Pure_miu
load Pure_id

load Biomass_pure
load 8SPC_0405
spc_lth=size(SPC,2);

Result_file_pairwise='pairwise_growth_0904.xlsx';

write_flag=0;
output_title=[];
output=[];
miu=[];
output_miu=[];
TSpan=0:0.02:24;
for i=1:spc_lth
    subs_cn{i}=SPC{i}.subs_cn;
    Expdata{i}=SPC{i}.expdata;
    met{i}=SPC{i}.met_udf;

%     if find(strcmpi('Hexose',met{i}(subs_cn{i})))    %%?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????acetate????????????????????????????
      if i<=5  
        Sug_org=SPC{i}.expdata(1,3);
        SPC{i}.expdata(1,3)=80;

      elseif i==6   %% E.hallii
            SPC{i}.expdata(1,3)=60;   %% ????????????????????????acetate
      else
            SPC{i}.expdata(1,3)=80;   %% ????????????????????acetate
            SPC{i}.expdata(1,4)=60;    %% 
      end
      SPC{i}.expdata(1,2)=0.01/SPC{i}.biom_coef;
end

for i=1:spc_lth
    SPC1=SPC{i};
    met1=SPC1.met_udf;
    for j=i:spc_lth
        SPC2=SPC{j};
        met2=SPC2.met_udf;

        [Com_ij,miu_comm]=common_com_pairwise_Interaction({SPC1,SPC2},2);
        output_title_ij={SPC1.id,SPC2.id};
        output_title=[output_title output_title_ij];
        output=[output Com_ij];
        output_miu=[output_miu miu_comm];
    end
end

[spcr,spcn]=size(output);   
flag=0;
for i=1:spc_lth   
    for j=i:spc_lth
        pair_fc(:,2*(j-i+1)-1+flag)=log2(output(end,2*(j-i+1)-1+flag)./Biomass_pure(end,i));   %%??????????????????????????????????i????????????????????????????????????????????????????????????????????????
        pair_fc(:,2*(j-i+1)+flag)=log2(output(end,2*(j-i+1)+flag)./Biomass_pure(end,j));  %%??????????????????????????????j??????????????????????????????????????????????????;????????????????????
        pair_miu_fc(:,2*(j-i+1)-1+flag)=log2(max(output_miu(:,2*(j-i+1)-1+flag))./max(Pure_miu(:,i)));   %%??????????????????????????????????i??????
        pair_miu_fc(:,2*(j-i+1)+flag)=log2(max(output_miu(:,2*(j-i+1)+flag))./max(Pure_miu(:,j)));    %%??????????????????????????????j??????
    end
    flag=flag+(8-i+1)*2;
end

cd('./data');

xlwrite_Jun(Result_file_pairwise,['Time';num2cell(TSpan')],'Time'); 
xlwrite_Jun(Result_file_pairwise,[output_title;num2cell(output)],'Biomass');
xlwrite_Jun(Result_file_pairwise,[output_title;num2cell(output_miu)],'Growth_rate'); 
xlwrite_Jun(Result_file_pairwise,[output_title;num2cell(pair_fc)],'Biomass_log2_FC'); 
xlwrite_Jun(Result_file_pairwise,[output_title;num2cell(pair_miu_fc)],'MaxMiu_log2_FC'); 
Pure_title=['Time' Pure_id]
xlwrite_Jun(Result_file_pairwise,[Pure_title;num2cell(Biomass_pure)],'Pure_Culture');   %% last command is to add the pure culture data


% xlswrite(Result_file_pairwise{1},TSpan','Time'); 
% xlswrite(Result_file_pairwise{2},output,'Biomass');
% xlswrite(Result_file_pairwise{3},output_miu,'Growth_rate'); 
% xlswrite(Result_file_pairwise{4},pair_fc,'Biomass_log2_FC'); 
% xlswrite(Result_file_pairwise{5},pair_miu_fc,'MaxMiu_log2_FC'); 
% xlswrite(Result_file_pairwise{6},Biomass_pure,'Pure_Culture'); 



% sheet_name=[SPC1.id, '_', SPC2.id];
% if length(sheet_name)>31
% %     inx=length(sheet_name)-31;
%     inx=find(isspace(SPC1.id));
%     spc1_name=SPC1.id(:,inx+1:end);
% end
% if length(sheet_name)>31
% %     inx=length(sheet_name)-31;
%     inx=find(isspace(SPC2.id));
%     spc2_name=SPC2.id(:,inx+1:end);
% end
% sheet_name=[];
% sheet_name=[spc1_name, '_', spc2_name];

% xlswrite(Result_file_pairwise,cell2mat(output),'sheet1'); 
% cd('D:\Research\BMGF project\Gut_infant\Dynami_Gut_Model\Species_Model\For_Manu\Pairwise_Interaction');


% legend ({'Pure Culture','Co-Culture'},'location','SouthEastOutside')
% legend ('boxoff')

% print 2.eps -depsc2 -r600
% print(gcf,'-djpeg','-r300')
function unify_Initconc(SPClist)
  for i=1:length(SPClist)
%     [pathstr,name,ext]=fileparts(SPClist(i).name);
%     SPC=importSpecies(name);
    SPC{i}=SPClist{i};
    spc_name{i}=SPC{i}.id; 
    met{i}=SPC{i}.met_udf;
    subs_cn{i}=SPC{i}.subs_cn;
    biom_coef{i}=SPC{i}.biom_coef;
    biom_inx=strmatch('BIOM',met{i});
      if ismember('expdata',fields(SPC{i}))
         Expdata=SPC{i}.expdata;
         Time=Expdata(:,1);    %% this should be fixed format of species_info
         Data=Expdata(:,2:end);
         Data(any(isnan(Data)'),:) = [];  %%remove possible NAN appearing in Data
         Time(find(isnan(Time)),:) = [];
         [rexp cexp]=size(Data);
         Biomass{i}=Data(:,biom_inx);    
%          Data(:,biom_inx)=Data(:,biom_inx).*biom_coef;
         Substrate{i}=Data(:,subs_cn{i}); %% ??????????????????????????????subsrate
         conc_ini{i}=Data(1,:);
     end
  end
  %% 1. unifying mets names of each species, then insert zeros to those missing mets in each species %%
  met_co={};
  for s=1:length(SPClist)
        met_co=union(met_co,met{s},'stable');
  end
  if (subs_cn{1}(1)==2)&&(subs_cn{2}(1)==2)
      SPC{1}.expdata(1,biom_inx+1)=SPC{1}.expdata(1,biom_inx+1).* Substrate{1}(1,1)./max(Substrate{1}(1,1),Substrate{2}(1,1));   %%????????????????????time
      SPC{2}.expdata(1,biom_inx+1)=SPC{2}.expdata(1,biom_inx+1).* Substrate{2}(1,1)./max(Substrate{1}(1,1),Substrate{2}(1,1));
  end
  
%   for i=1:length(SPClist)
%       zidx{i}=find(conc_ini{i}==0)
%       conc_sim_ini{i}=new_conc_avg(met_idx{i});
%       conc_sim_ini{i}(zidx{i})=0;
%   end