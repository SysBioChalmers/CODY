function [Tmodel,Y,Ymodel,Ymodel_met,met_udf_co]=common_10tank_0402(community,n_spc,num_rct,FSG,Feed,flow_back,k,V,ini_stat,time,length_each_tank,km_lumen,Pn_mucosa,km_water,density,Met_Mass,hmo_para,vld,uv)
global lxini spc 
global SxZ_tot kmax KM ke alpha beta subs_cn biom_inx met_udf met_udf_co n_carbon met_udf_co_new
global Y_BM Y_SUB maxEnzyme kl rct obsv V_obsv t_obsv F5 length_additional kd C_Kd GLU_in GLU_obsv HMO_obsv
global lg_8tank  f_back   n_rct  km   km_w   Pn   rho mol_mass
global flag_meal1 flag_meal2 flag_meal3 flag_fece 
global HMO_in spc_hyd kmax_hmo KM_hmo Y_hmo HMO_const F5_obsv


n_rct=num_rct;
rct=n_rct;
if nargin<19
    uv=false;
end
 
if nargin<18
    vld=false;
end 

f_back=flow_back;
n_s=n_spc;
kl={};
kd=k(1,:)'; 
C_Kd=k(2,:)';   
km=km_lumen;
km_w=km_water;
Pn=Pn_mucosa;
rho=density;
mol_mass=Met_Mass./1000;

HMO_const=hmo_para(1);
spc_hyd=hmo_para(2:n_s+1);
kmax_hmo=hmo_para(n_s+2:2*n_s+1);
KM_hmo=hmo_para(2*n_s+2:3*n_s+1);
Y_hmo=hmo_para(3*n_s+2:end);

 for s=1:n_s
     spc{s}=community{s};

     name{s}=spc{s}.id;
     SxZ{s}=spc{s}.S;
     kmax{s}=spc{s}.kmax;
%      kmax{s}=spc{s}.kmax.*6;
     K_MM{s}=spc{s}.KM;
     ke{s}=spc{s}.ke;
     alpha{s}=spc{s}.alpha;
     beta{s}=spc{s}.beta;
%      ke{s}=spc{s}.ke;
     met_udf{s}=spc{s}.met_udf;
     e_rel{s}=spc{s}.e_rel;
     subs_cn{s}=spc{s}.subs_cn;
     
     if exist('bm_coef')
         biom_coef{s}=bm_coef{s};
     else
         biom_coef{s}=spc{s}.biom_coef;
     end
     
     n_carbon{s}=spc{s}.n_carbon;  
     [cr,cl]=size(n_carbon{s}); 
     if (cr>1)&&(cl>1)
        disp('this species use more than one cl species');
     end
     biom_inx{s}=strmatch('BIOM',met_udf{s});
    [sr,sl]=size(SxZ{s});
    n_ezm=sl;
    kl{s}=length(kmax{s});
    KM{s}=[];
    for i=1:length(subs_cn{s})
        KM{s}(:,i)=K_MM{s}(:,i).*ones(kl{s},1);  
    end
    alpha{s}=alpha{s}.*ones(kl{s},1);   
    beta{s}=beta{s}.*ones(kl{s},1);
    ke{s}=ke{s}.*ones(kl{s},1); 
    e_rel{s}=e_rel{s}.*ones(kl{s},1); 

    Y_BM{s}=SxZ{s}(1,:)';
    Y_SUB{s}=SxZ{s}(subs_cn{s},:)';     
    maxmue{s}=kmax{s}.*Y_BM{s};
    maxEnzyme{s}=(ke{s}+alpha{s})./(beta{s}+maxmue{s}); 
    e0{s}=e_rel{s}.*maxEnzyme{s};      
    para{s}=kmax{s};
    options_ode=[];
 end
 
met_co={};
for s=1:n_s
        met_co=union(met_co,met_udf{s},'stable');
end
met_co(1)=[]; 

 for s=1:n_s
    met_udf{s}{1}=[met_udf{s}{1} '_' name{s}];
end

met_udf_co={};
bm_co={};
for s=1:n_s
        met_udf_co=union(met_udf_co,met_udf{s},'stable');
        bm_co=union(bm_co,met_udf{s}(1),'stable');
end
clear_index=[];
for i=1:length(met_udf_co)   %%%%%%%% remove the elements begins with 'BIOMASS',for each species,the first row is always biomass, other row sequence is determined by union command
    if ~isempty(strmatch('BIOMASS',met_udf_co{i}))
        clear_index=[clear_index;i];
    end
end
met_udf_co(clear_index)=[]; %%%%%% first remove all biomass
met_udf_co=union(bm_co,met_udf_co,'stable'); %% then add all biomass_ in the beginning of met_udf_co;

cm_met={}; 
[cm_met,SxZ_tot]=calc_SxZ_4m(met_udf_co,met_udf,SxZ,n_s);

%%
met_udf_co_new={};
bm_new=[met_udf_co(1:n_s); met_udf_co(1:n_s)];
met_udf_co_new(1:2*n_s)=bm_new;
met_udf_co_new(2*n_s+1:2*n_s+length(met_udf_co)-n_s)=met_udf_co(n_s+1:end);
met_udf_co_new=met_udf_co_new';

met_udf_co(n_s+2:end+1)=met_udf_co(n_s+1:end);
met_udf_co(n_s+1)={'HMO'};

    sub_index_temp=[];
    for i=1:n_s
        for j=1:length(subs_cn{i})
           sub_index_temp(i,j)=strmatch(met_udf{i}(subs_cn{i}(j)),met_udf_co);   %% ????????????????????????????????????????????????????????????5?????????????????????????????????????????????????????????????0
        end
    end
    hmo_ix=find(strcmp('HMO',met_udf_co));
for k=1:n_rct-1
    HMO_index(k)=hmo_ix+(k-1).*length_each_tank;  %% this HMO??????????????????????????????hmo???????????????????????????????????????????????????????????????????????????????y???????????????dhmo/dt??????
end
k=n_rct;  %% blood???????????????hmo????????????????
%% 1. ??????????????????????????????????????hmo????????????????
    HMO_index(k)=(k-1).*length_each_tank+length(met_udf_co)+1+hmo_ix-n_s;
%% ??????????????????????????????????????????????????????????y???????????????index %%
   [sr,sc]=size(sub_index_temp);
   sub_shape=reshape(sub_index_temp,sr*sc,1);
   t_inx=length(sub_shape);
   subset_t=1:t_inx;
   sub_set_inx=find(sub_shape>0);  %% ???????????????????????????????????????????????????????????????????y???????????????????????
   nan_set_inx=setxor(subset_t,sub_set_inx);
%     Substrate_index(k)=sub_index_temp+(k-1).*length_each_tank;
sub_index_new=zeros(t_inx,1);
for k=1:n_rct-1
    sub_index_new=zeros(t_inx,1);
    sub_index_new(sub_set_inx)=sub_shape(sub_set_inx)+(k-1).*length_each_tank;
    sub_index_new(nan_set_inx)=nan;
    temp_sub_cell=reshape(sub_index_new,sr,sc);
    pre_sub_cell=num2cell(temp_sub_cell',[1,n_s]);  %%?????????????????????????????cell, pre_sub_cell????????k????????????????????????8????????????????????????????????????????????
    for ss=1:n_s
        pre_sub_cell{ss}(isnan(pre_sub_cell{ss}))=[];   %%
    end
    substrate_index{k}=pre_sub_cell;   %%??????qssm????????????????????????????????????????????????????????????????????????
end
    
%% ??????????????????????index %%
lg_met_co=length(met_udf_co);
lg_enzyme=length_each_tank-lg_met_co;
ylg=length_each_tank;
for k=1:rct-1
    for i=1:n_s
        enzyme_index{k}{i}=((lg_met_co+1+(k-1).*ylg):(lg_met_co+length(kmax{i})+(k-1).*ylg))';     %% ????????5??????????????????fluid???????????????,????????????????????????????????fluid???????????????????????????????????????????????????
%         e{k}{i+ns}=y((lx+lxe+1+(k-1).*ylg):(lx+lxe+length(kmax{i})+(k-1).*ylg));  %% ????????biofilm????????????????????????????????????????????y?????????????????????????????????????5??????????????????????????????????????????????????????biofilm?????????????????????????????????????????????
        lg_met_co=lg_met_co+length(kmax{i});
    end
    lg_met_co=length(met_udf_co);
end 
%% ??????????????KM?????????????? %%
    for i=1:n_s
        if length(subs_cn{i}>1)
            [rkm,ckm]=size(KM{i});
            if ckm==1
                for j=1:length(subs_cn{i})
                    KM{i}(:,j)=KM{i}(:,1);
                end
            end
        end
    end
%%

lxini=length(met_udf_co);
e_ini=[];
e_ini_X=[];
for s=1:n_s
    e_ini=[e_ini;e0{s}];
    e_ini_X=[e_ini_X;e0{s}];   %%??????biofilm???????????????????????????????????????????
end

V_rct=0.00001;  %%?????????????????????????????????????????????V4??????????????????????????????????????0???????????????????????????????????sigularity????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
% y0=[ini_stat;V_rct];  %%?????????????????????????????V_rectum????????????????????????????????????????????????????????y???????????????????????????????????
y0=ini_stat;
lg_8tank=length_each_tank;
y0(9*lg_8tank+1)=V_rct;
% length_additional=length(y0)-length(ini_stat);
% tspan=[0:0.01:time];
options_ode=odeset('maxstep',0.01);
obsv=1;   %%?????????????????????????????????qssm????????????????????????????V4??????????????????????????????????
V_obsv=V_rct;
t_obsv=0;
F5=0; %%??????F4????????????????global????????????????????????????0????????????????????????????????????????????????????????????????????????????????????????????
GLU_in=0;%%????????????????????????????????????????????????????0????????????????????????????????????????????????
HMO_in=0;  %% ????????????????glucose feeding?????????????????????????????hmo feeding??????????????????????????????????????????????
GLU_obsv=[];HMO_obsv=[];F5_obsv=F5;

% tspan=[0;300;0.05];
tspan=[0;300;0.01];
tspan=[0;302;0.01];

[T Y]=my_runge_kutta4_smp_wait(@qssm_comm_10rct_HMO_VLD_3feces_6fed,y0,tspan,kmax,n_s,FSG,Feed,V,substrate_index,HMO_index,enzyme_index);
% [T Y]=my_runge_kutta4_smp_wait(@qssm_comm_10rct_HMO_VLD_3feces,y0,tspan,kmax,n_s,FSG,Feed,V,substrate_index,HMO_index,enzyme_index);


ylg=lg_8tank;   %%??8????????????????????????????????????????????????????????

Tmodel=T;
[ys,yl]=size(Y);
Y(Y<0)=eps;
for k=1:rct-2
    Ymodel{k}=Y(:,1+(k-1).*ylg:ylg+(k-1).*ylg); %% Ymodel????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
    Ymodel_met{k}=Y(:,1+(k-1).*ylg:lxini+(k-1).*ylg); %% ?????????????????????????????????????????????????????????
end
% ylg=lg_standard;
k=9;
Ymodel{k}=Y(:,1+(k-1).*ylg:ylg+1+lxini+(k-1).*ylg);
Ymodel_met{k}=Y(:,1+(k-1).*ylg:lxini+(k-1).*ylg);
V5_rctm=Y(:,(k-1)*ylg+ylg+1);  %%??????????????????????????????????V5???????????????????????????????????????????????????????????????????????????????????????????????????????
Ymodel_mass_rctm=Y(:,(k-1)*ylg+ylg+1+1:(k-1).*ylg+ylg+1+lxini);    %%??????????????????????????????????x1V5-x5V5????????hexoseV5-H2V5

k=10;
Ymodel{k}=Y(:,(k-1).*ylg+1+lxini+1:(k-1).*ylg+1+lxini+lxini-n_s);    %% no bacteria, only metabolites

leglbl_bm=[];
for i=1:n_s
   switch i
    case 1
        line{i}='k-';
%         leglbl_bm=[leglbl_bm;met_udf_co{i}];
    case 2
        line{i}='k--';
%         leglbl_bm=[leglbl_bm;met_udf_co{i}];
    case 3
        line{i}='r-';
%         leglbl_bm=[leglbl_bm;met_udf_co{i}];
    case 4
        line{i}='r--';
%         leglbl_bm=[leglbl_bm;met_udf_co{i}];
    case 5
        line{i}='b-';
%         leglbl_bm=[leglbl_bm;met_udf_co{i}];
    case 6
        line{i}='b--';
%         leglbl_bm=[leglbl_bm;met_udf_co{i}];
    case 7
        line{i}='g-';
%         leglbl_bm=[leglbl_bm;met_udf_co{i}];
    case 8
        line{i}='g--';
%         leglbl_bm=[leglbl_bm;met_udf_co{i}];
    case 9
        line{i}='m-';
    case 10
        line{i}='m--.';
    end
end

for i=n_s+1:length(met_udf_co)
   switch i-n_s
    case 1
        color{i-n_s}=[0.15  0  0];
%         color{i-n_s}=[0.905  0.192  0.199];
%         leglbl_prd=[leglbl_prd;met_udf_co{i}];
    case 2
%         color{i-n_s}=[0.5  0.5  0.5];
        color{i-n_s}=[1.0  0.548  0.1];
%         leglbl_prd=[leglbl_prd;met_udf_co{i}];
    case 3
%         color{i-n_s}=[1  0.8  0];
        color{i-n_s}=[0.972  0.555  0.774];
%         leglbl_prd=[leglbl_prd;met_udf_co{i}];
    case 4
        color{i-n_s}=[1  0  1];
%         leglbl_prd=[leglbl_prd;met_udf_co{i}];
    case 5
        color{i-n_s}=[0.8  0.8  0.8];
        color{i-n_s}=[0.865 0.811 0.433];

%         leglbl_prd=[leglbl_prd;met_udf_co{i}];
    case 6
%         color{i-n_s}=[0.3  0.3  0.6];
        color{i-n_s}=[0.294  0.545  0.749];
%         leglbl_prd=[leglbl_prd;met_udf_co{i}];
    case 7
%         color{i-n_s}=[0.1  0.8  0.3];
        color{i-n_s}=[0.372  0.718  0.361];
%         leglbl_prd=[leglbl_prd;met_udf_co{i}];
    case 8
        color{i-n_s}=[0.2  0.8  0.2];
%         leglbl_prd=[leglbl_prd;met_udf_co{i}];
    case 9
        color{i-n_s}=[0.5  1  0.5];
%         leglbl_prd=[leglbl_prd;met_udf_co{i}];
    case 10
        color{i-n_s}=[1   1  0.2];
%         leglbl_prd=[leglbl_prd;met_udf_co{i}];
    end
end

% plot_simulation_result(Tmodel,Ymodel_met,met_udf_co,n_s);
 


